# PostgreSQL - Connection Test

## Configuration

```bash
# Option 1: Full Connection URL
export DATABASE_URL="postgresql://username:password@localhost:5432/mydb"

# Option 2: Individual Components
export POSTGRES_HOST="localhost"
export POSTGRES_PORT="5432"
export POSTGRES_USER="postgres"
export POSTGRES_PASSWORD="your_password_here"
export POSTGRES_DB="mydb"
export POSTGRES_SCHEMA="public"   # Optional, defaults to "public"

# Optional: SSL Mode
export POSTGRES_SSLMODE="prefer"  # disable, allow, prefer, require, verify-ca, verify-full
```

## Authentication

PostgreSQL uses password authentication.

Connection URL format:
```
postgresql://user:password@host:port/database
postgresql://user:password@host:port/database?sslmode=require
```

## Base URL / Host

```
localhost:5432              # Local development
postgres.example.com:5432   # Remote PostgreSQL
postgres.example.com:25060  # DigitalOcean Managed
```

## Health Check Query

```sql
SELECT 1
```

## psql Examples

### Basic Connection

```bash
psql -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB}
```

### Connection with Password (non-interactive)

```bash
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} \
  -p ${POSTGRES_PORT} \
  -U ${POSTGRES_USER} \
  -d ${POSTGRES_DB} \
  -c "SELECT 1"
```

### Using Connection URL

```bash
psql "${DATABASE_URL}" -c "SELECT 1"
```

### Connection with SSL

```bash
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} \
  -p ${POSTGRES_PORT} \
  -U ${POSTGRES_USER} \
  -d ${POSTGRES_DB} \
  "sslmode=require" \
  -c "SELECT 1"
```

### Connection with SSL and Custom CA

```bash
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} \
  -p ${POSTGRES_PORT} \
  -U ${POSTGRES_USER} \
  -d ${POSTGRES_DB} \
  "sslmode=verify-ca sslrootcert=/path/to/ca-bundle.crt" \
  -c "SELECT 1"
```

## Sample Queries

### Database Info

```bash
# List databases
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} \
  -c "SELECT datname FROM pg_database WHERE datistemplate = false;"

# List tables
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} \
  -c "SELECT tablename FROM pg_tables WHERE schemaname = 'public';"

# List schemas
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} \
  -c "SELECT schema_name FROM information_schema.schemata;"
```

### Server Status

```bash
# PostgreSQL version
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} \
  -c "SELECT version();"

# Current connections
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} \
  -c "SELECT count(*) FROM pg_stat_activity;"

# Database size
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} \
  -c "SELECT pg_size_pretty(pg_database_size(current_database()));"
```

### Table Operations

```bash
# Create table
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} \
  -c "CREATE TABLE IF NOT EXISTS test_table (id SERIAL PRIMARY KEY, name VARCHAR(100));"

# Insert data
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} \
  -c "INSERT INTO test_table (name) VALUES ('Test Entry');"

# Query data
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} \
  -c "SELECT * FROM test_table;"
```

## Python Quick Test

```python
import psycopg2
import os

# Using individual components
conn = psycopg2.connect(
    host=os.getenv('POSTGRES_HOST', 'localhost'),
    port=int(os.getenv('POSTGRES_PORT', 5432)),
    user=os.getenv('POSTGRES_USER'),
    password=os.getenv('POSTGRES_PASSWORD'),
    dbname=os.getenv('POSTGRES_DB'),
)

# Test connection
cur = conn.cursor()
cur.execute('SELECT 1')
print(cur.fetchone())  # (1,)
conn.close()
```

## Expected Response (Health Check)

```
 ?column?
----------
        1
(1 row)
```

## SSL Modes

| Mode | Description |
|------|-------------|
| `disable` | No SSL |
| `allow` | Use SSL if available |
| `prefer` | Try SSL first, fallback to non-SSL |
| `require` | SSL required, no verification |
| `verify-ca` | SSL required, verify CA |
| `verify-full` | SSL required, verify CA and hostname |

## Troubleshooting

### Connection Refused

```bash
# Check if PostgreSQL is running
pg_isready -h ${POSTGRES_HOST} -p ${POSTGRES_PORT}

# Check connection with verbose output
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} \
  -c "SELECT 1" 2>&1
```

### Authentication Error

```bash
# Verify credentials
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d postgres \
  -c "SELECT current_user;"
```

### SSL Certificate Error

```bash
# Connect without SSL verification (for testing only)
PGPASSWORD="${POSTGRES_PASSWORD}" psql \
  -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -d ${POSTGRES_DB} \
  "sslmode=require" \
  -c "SELECT 1"
```
